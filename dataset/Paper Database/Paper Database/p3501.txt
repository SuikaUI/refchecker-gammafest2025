Pebble Games and Linear Equations
Martin Grohe1 and Martin Otto∗2
Humboldt-Universität zu Berlin, Germany
 
Technische Universität Darmstadt, Germany
 
We give a new, simpliﬁed and detailed account of the correspondence between levels of the Sherali–
Adams relaxation of graph isomorphism and levels of pebble-game equivalence with counting
(higher-dimensional Weisfeiler–Lehman colour reﬁnement). The correspondence between basic
colour reﬁnement and fractional isomorphism, due to Ramana, Scheinerman and Ullman , is
re-interpreted as the base level of Sherali–Adams and generalised to higher levels in this sense
by Atserias and Maneva , who prove that the two resulting hierarchies interleave. In carrying
this analysis further, we here give (a) a precise characterisation of the level k Sherali–Adams
relaxation in terms of a modiﬁed counting pebble game; (b) a variant of the Sherali–Adams
levels that precisely match the k-pebble counting game; (c) a proof that the interleaving between
these two hierarchies is strict. We also investigate the variation based on boolean arithmetic
instead of real/rational arithmetic and obtain analogous correspondences and separations for
plain k-pebble equivalence (without counting). Our results are driven by considerably simpliﬁed
accounts of the underlying combinatorics and linear algebra.
1998 ACM Subject Classiﬁcation F.4.1, G.2.2
Keywords and phrases Finite model theory, ﬁnite variable logics, graph isomorphism, Weisfeiler-
Lehman algorithm, linear programming, Sherali–Adams hierarchy
Digital Object Identiﬁer 10.4230/LIPIcs.CSL.2012.289
Introduction
We study a surprising connection between equivalence in ﬁnite variable logics and a linear
programming approach to the graph isomorphism problem. This connection has recently
been uncovered by Atserias and Maneva , building on earlier work of Ramana, Scheinerman
and Ullman that just concerns the 2-variable case.
Finite variable logics play a central role in ﬁnite model theory. Most important for
this paper are ﬁnite variable logics with counting, which have been speciﬁcally studied
in connection with the question for a logical characterisation of polynomial time and in
connection with the graph isomorphism problem (e.g. ). Equivalence in
ﬁnite variable logics can be characterised in terms of simple combinatorial games known as
pebble games. Speciﬁcally, Ck-equivalence can be characterised by the bijective k-pebble game
introduced by Hella . Cai, Fürer and Immerman observed that Ck-equivalence exactly
corresponds to indistinguishability by the k-dimensional Weisfeiler-Lehman (WL) algorithm,1
∗This Martin gratefully acknowledges the other Martin’s academic hospitality at HU Berlin during his
sabbatical in the winter 2011/12.
1 The dimensions of the WL algorithm are counted diﬀerently in the literature; what we call “k-dimensional”
here is sometimes called “(k −1)-dimensional”.
© Martin Grohe and Martin Otto;
licensed under Creative Commons License NC-ND
Computer Science Logic 2012 (CSL’12).
Editors: Patrick Cégielski, Arnaud Durand; pp. 289–304
Leibniz International Proceedings in Informatics
Schloss Dagstuhl – Leibniz-Zentrum für Informatik, Dagstuhl Publishing, Germany
Pebble Games and Linear Equations
a combinatorial graph isomorphism algorithm introduced by Babai, who attributed it to
work of Weisfeiler and Lehman in the 1970s. The 2-dimensional version of the WL algorithm
precisely corresponds to an even simpler isomorphism algorithm known as colour reﬁnement.
The isomorphisms between two graphs can be described by the integral solutions of a
system of linear equations. If we have two graphs with adjacency matrices A and B, then
each isomorphism from the ﬁrst to the second corresponds to a permutation matrix X such
that XtAX = B, or equivalently
If we view the entries of X as variables, this equation corresponds to a system of linear
equations. We can add inequalities that force X to be a permutation matrix and obtain
a system ISO of linear equations and inequalities whose integral solutions correspond to
the isomorphisms between the two graphs. In particular, the system ISO has an integral
solution if, and only if, the two graphs are isomorphic.
What happens if we drop the integrality constraints, that is, we admit arbitrary real
solutions of the system ISO? We can ask for doubly stochastic matrices X satisfying equation
(1). (A real matrix is doubly stochastic if its entries are non-negative and all row sums and
column sums are one.) Ramana, Scheinerman and Ullman proved a beautiful result that
establishes a connection between linear algebra and logic: the system ISO has a real solution
if, and only if, the colour reﬁnement algorithm does not distinguish the two graphs with
adjacency matrices A and B. Recall that the latter is equivalent to the two graphs being
C2-equivalent.
To bridge the gap between integer linear programs and their LP-relaxations, researchers
in combinatorial optimisation often add additional constraints to the linear programs to bring
them closer to their integer counterparts. The Sherali–Adams hierarchy of relaxations
gives a systematic way of doing this. For every integer linear program IL in n variables and
every positive integer k, there is a rank-k Sherali–Adams relaxation IL(k) of IL, such that
IL(1) is the standard LP-relaxation of IL where all integrality constraints are dropped and
IL(n) is equivalent to IL. There is a considerable body of research studying the strength of
the various levels of this and related hierarchies (e.g. ).
Quite surprisingly, Atserias and Maneva were able to lift the Ramana–Scheinerman–
Ullman result, which we may now restate as an equivalence between ISO(1) and C2equivalence, to a close correspondence between the higher levels of the Sherali–Adams
hierarchy for ISO and the logics Ck. They proved for every k ≥2:
1. if ISO(k) has a (real) solution, then the two graphs are Ck-equivalent;
2. if the two graphs are Ck-equivalent, then ISO(k −1) has a solution.
Atserias and Maneva used this results to transfer results about the logics Ck to the world of
polyhedral combinatorics and combinatorial optimisation, and conversely, results about the
Sherali–Adams hierarchy to logic.
Atserias and Maneva left open the question whether the interleaving between the
levels of the Sherali–Adams hierarchy and the ﬁnite-variable-logic hierarchy is strict or
whether either the correspondence between Ck-equivalence and ISO(k) or the correspondence
between Ck-equivalence and ISO(k −1) is exact. Note that for k = 2 the correspondence
between Ck-equivalence and ISO(k −1) is exact by the Ramana–Scheinerman–Ullman
theorem. We prove that for all k ≥3 the interleaving is strict. However, we can prove an
exact correspondence between ISO(k −1) and a variant of the bijective k-pebble game that
characterises Ck-equivalence. This variant, which we call the weak bijective k-pebble game,
is actually equivalent to a game called (k −1)-sliding game by Atserias and Maneva.
M. Grohe and M. Otto
Maybe most importantly, we prove that a natural combination of equalities from ISO(k)
and ISO(k−1) gives a linear program ISO(k−1/2) that characterises Ck-equivalence exactly.
To obtain these results, we give simple new proofs of the theorems of Ramana, Scheinerman
and Ullman and of Atserias and Maneva. Whereas the previous proofs use two non-trivial
results from linear algebra, the Perron–Frobenius Theorem (about the eigenvalues of positive
matrices) and the Birkhoﬀ–von Neumann Theorem (stating that every doubly stochastic
matrix is a convex combination of permutation matrices), our proofs only use elementary
linear algebra. This makes them more transparent and less mysterious (at least to us).
In fact, the linear algebra we use is so simple that much of it can be carried out not
only over the ﬁeld of real numbers, but over arbitrary semirings. By using similar algebraic
arguments over the boolean semiring (with disjunction as addition and conjunction as
multiplication), we obtain analogous results to those for Ck-equivalence for the ordinary
k-variable logic Lk, characterising Lk-equivalence, i.e., k-pebble game equivalence without
counting, by systems of ‘linear’ equations over the boolean semiring.
For the ease of presentation, we have decided to present our results only for undirected
simple graphs. It is easy to extend all results to relational structures with at most binary
relations. Atserias and Maneva did this for their results, and for ours the extension works
analogously. An extension to structures with relations of higher arities also seems possible,
but is more complicated and comes at the price of loosing some of the elegance of the results.
Due to space limitations, we have to omit many details and proofs in this conference version
of the paper. They can be found in the full version of the paper . The present version
of the paper contains a fairly complete account of our proof of the Ramana–Scheinerman–
Ullman theorem, including the linear algebra that is also underlying they higher-dimensional
results. Most proofs regarding the correspondence between the Sherali–Adams hierarchy and
Ck-equivalence are omitted.
Finite variable logics and pebble games
We assume the reader is familiar with the basics of ﬁrst-order logic FO. We almost exclusively
consider ﬁrst-order logic over ﬁnite graphs, which we view as ﬁnite relational structures
with one binary relation. We assume graphs to be undirected and loop-free. For every
positive integer k, we let Lk be the fragment of FO consisting of all formulae that contain
at most k distinct variables. We let Ck be the extension of Lk by counting quantiﬁers
∃≥n, where∃≥nx ϕ means that there are at least n elements x such that ϕ is satisﬁed. Lkequivalence of structures A, B is denoted by A ≡k
L B and Ck-equivalence by A ≡k
equivalences can be characterised in terms of pebble games. We brieﬂy sketch the bijective
k-pebble game that characterises Ck-equivalence. The game is played by two players on a
pair A, B of structures. A play of the game consists of a (possibly inﬁnite) sequence of rounds.
In each round, player I picks up one of his pebbles, and player II picks up her corresponding
pebble. Then player II chooses a bijection f between A and B (if no such bijection exists,
that is, if the structures have diﬀerent cardinalities, player II immediately looses). Then
player I places his pebble on an element a of A, and player II places her pebble on f(a).
Note that after each round r there is a subset p ⊆A × B consisting of the at most k pairs of
elements on which the pairs of corresponding pebbles are placed. We call p the position after
round r. Player I wins the play if every position that occurs is a local isomorphism, that is, a
local mapping from A to B that is injective and preserves membership and non-membership
in all relations (adjacency and non-adjacecny if A and B are graphs). Then A ≡k
C B if, and
only if, player II has a winning strategy for the game.
Pebble Games and Linear Equations
Ck-equivalence also corresponds to a simple combinatorial algorithm for graph isomorphism
testing known as the Weisfeiler-Lehman algorithm.
We refer the reader to the textbooks and the monograph for a more
thorough exposition of the material sketched here.
Basic combinatorics and linear algebra
We consider matrices with entries in B = {0, 1}, Q or R. A matrix X ∈Rm,n with m rows
and n columns has entry Xij in row i ∈[m] = {1, . . . , m} and column j ∈[n] = {1, . . . , n}.
We write En for the n-dimensional unit matrix.
We write X ⩾0 to say that (the real or rational) matrix X has only non-negative entries,
and X > 0 to say that all entries are strictly positive. We also speak of non-negative or
strictly positive matrices in this sense. For a boolean matrix, strict positivity, X > 0 means
that all entries are 1. A square n×n-matrix is doubly stochastic if its entries are non-negative
and if the sum of entries across every row and column is 1. Permutation matrices are doubly
stochastic matrices over {0, 1}, with precisely one 1 in every row and in every column.
It will be useful to have the shorthand notation XD1D2 = 0 for the assertion that
Xd1d2 = 0 for all d1 ∈D1, d2 ∈D2.
Decomposition into irreducible blocks
With X ∈Rn,n associate the directed graph G(X) := ([n], {(i, j): Xij ̸= 0}). The strongly
connected components of G(X) induce a partition of the set [n] = {1, . . . , n} of rows/columns
of X. X is called irreducible if this partition has just the set [n] itself.
Note that X is irreducible iﬀP tXP is irreducible for every permutation matrix P.
▶Observation 3.1. Let X ∈Rn,n ⩾0 with strictly positive diagonal entries. If X is
irreducible, then all powers Xℓfor ℓ⩾n −1 have non-zero entries throughout. Moreover, if
X is irreducible, then so is Xℓfor all ℓ⩾1.
Let us call two matrices Z, Z′ ∈Rn,n permutation-similar or Sn-similar, Z ∼Sn Z′, if
Z′ = P tZP for some permutation matrix P, i.e., if one is obtained from the other by a
coherent permutation of rows and columns.
▶Lemma 3.2. Every symmetric Z ∈Rn,n ⩾0 is permutation-similar to some block diagonal
matrix diag(Z1, . . . , Zs) with irreducible blocks Zi ∈Rni,ni.
The permutation matrix P corresponding to the row- and column-permutation p ∈Sn that
puts Z into block diagonal form P tZP = diag(Z1, . . . , Zs) with irreducible blocks, is unique
up to an outer permutation that re-arranges the block intervals ([ki + 1, ki + ni])1⩽i⩽s where
j<i nj, and a product of inner permutations within each one of these s blocks.
The underlying partition [n] = ˙S
1⩽i⩽sDi where Di := p([ki +1, ki +ni]) for ki = P
is uniquely determined by Z.2
In the following we refer to the partition induced by a symmetric matrix Z.
2 Here we regard two partitions as identical if they have the same partition sets, i.e., we ignore their
indexing/enumeration.
M. Grohe and M. Otto
▶Observation 3.3. In the situation of Lemma 3.2, the partition [n] = ˙S
iDi induced by the
symmetric matrix Z is the partition of [n] into the vertex sets of the connected components
of G(Z). Then, for every pair i ̸= j, ZDiDj = 0, while all the minors ZDiDi are irreducible.3
If, moreover, Z has strictly positive diagonal entries, then the partition induced by Z is
the same as that induced by Zℓ, for any ℓ⩾1; for ℓ⩾n −1, the diagonal blocks (Zℓ)DiDi
have non-zero entries throughout: (Zℓ)DiDi > 0 .
The last assertion says that for a symmetric n×n matrix Z with non-negative entries
and no zeroes on the diagonal, all powers Zℓfor ℓ⩾n −1 are good symmetric in the sense
of the following deﬁnition.
▶Deﬁnition 3.4. Let Z ⩾0 be symmetric with strictly positive diagonal. Then Z is called
good symmetric if w.r.t. the partition [n] = ˙S
iDi induced by Z, all ZDiDi > 0.
More generally, a not necessarily symmetric matrix X ⩾0 without null rows or columns
is good if Z = XXt and Z′ = XtX are good in the above sense.
The importance of this notion lies in the fact that, as observed above, for an arbitrary
symmetric n×n matrix Z ⩾0 without zeroes on the diagonal, the partition induced by Z is
the same as that induced by the good symmetric matrix ˆZ := Zn−1; and, as for any good
matrix, this partition can simply be read oﬀfrom ˆZ: i, j ∈[n] are in the same partition set
if, and only if, ˆZij ̸= 0.
▶Deﬁnition 3.5. Consider partitions [n] = ˙S
i∈IDi and [m] = ˙S
i of the sets [n] and
[m] with the same number of partition sets. We say that these two partitions are X-related
for some matrix X ∈Rn,m if
(i) X ⩾0 has no null rows or columns, and
(ii) XDiDj′ = 0 for every pair of distinct indices i, j ∈I.
Note that partitions that are X-related are Xt-related in the opposite direction. More
importantly, each one of the X/Xt-related partitions can be recovered from the other one
through X according to
{d′ ∈[m]: Xdd′ > 0 for some d ∈Di},
{d ∈[n]: Xdd′ > 0 for some d′ ∈D′
For a more algebraic treatment, we associate with the partition sets Di of a partition
i∈IDi the characteristic vectors di with entries 1 and 0 according to whether the
corresponding component belongs to Di:
where ed is the d-th standard basis vector. In terms of these characteristic vectors di for
i∈IDi and d′
i for [m] = ˙S
i, the X/Xt-relatedness of these partitions means that
{d′ ∈[m]: (Xtdi)d′ > 0},
{d ∈[n]: (Xd′
3 Note that this does not depend on the enumeration of the partition set Di, because irreducibility is
invariant under permutation-similarity.
Pebble Games and Linear Equations
▶Lemma 3.6. If two partitions [n] = ˙S
i∈IDi and [n] = ˙S
i of the same set [n] are
X-related for some doubly stochastic matrix X ∈Rn,n, then |Di| = |D′
i| for all i ∈I, and
for the characteristic vectors di and d′
i of the partition sets Di and D′
Proof. Observe that for all d ∈[n] we have 0 ≤(Xd′
i Xdd′ ≤1. It follows
immediately from the deﬁnition of X-relatedness that (Xd′
i)d = 0 for all d ̸∈Di. Therefore,
Xdd′ = |D′
Similarly, 0 ≤(Xtdi)d′ ≤1 for d′ ∈[n], and |D′
i(Xtdi)d′ = |Di|. Together,
As all summands are bounded by 1, this implies (Xd′
i)d = 1 for all d ∈Di and (Xtdi)d′ = 1
for all d′ ∈Di.
▶Lemma 3.7. Let X ⩾0 be an m×n matrix without null rows or columns. Then the m×m
matrix Z := XXt and the n×n matrix Z′ := XtX are symmetric with positive entries on
their diagonals. Moreover, the (unique) partitions of [m] and [n] that are induced by Z and
Z′, respectively, are X/Xt-related.4
Proof. It is obvious that Z and Z′ are symmetric with positive diagonal entries.
partitions [m] = ˙S
i∈IDi and [n] = ˙S
i be obtained from decompositions of Z and Z′
into irreducible blocks. We need to show that the non-zero entries in X give rise to a coherent
bijection between the index sets I and I′ of the two partitions, in the sense that partition
sets Di and D′
j are related if, and only if, some pair of members d ∈Di and d′ ∈D′
positive entry Xdd′. Then a re-numbering of one of these partitions will make them X-related
in the sense of Deﬁnition 3.5. Recall from Observation 3.3 that the Di are the vertex sets of
the connected components of G(XXt) on [m], while the D′
i the are the vertex sets of the
connected components of G(XtX) on [n].
Consider the uniformly directed bipartite graph G(X) on [m] ˙∪[n] with an edge from
i ∈[m] to j ∈[n] if Xij > 0. In light of the symmetry of the whole situation w.r.t. X and
Xt, it just remains to argue for instance that no i ∈[m] can have edges into two distinct
sets of the partition [n] = ˙S
i. But any two target nodes of edges from one and the
same i ∈[n] are in the same connected component of G(XtX), hence in the same partition
In the situation of Lemma 3.7, powers of Z induce the same partitions as Z, and the
partitions induced by (ZℓX)(ZℓX)t = Z2ℓ+1 are X/Xt-related as well as ZℓX/XtZℓ-related,
for all ℓ⩾1.
For ℓ⩾n/2 −1, the matrix ZℓX has no null rows or columns: else ZℓX(ZℓX)t = Z2ℓ+1
would have to have a zero entry on the diagonal, contradicting the fact that this symmetric
matrix is good symmetric in the sense of Deﬁnition 3.4. The same reasoning shows that
ZℓX is itself good in the sense of Deﬁnition 3.4.
4 As X/Xt-relatedness refers to partitions presented with an indexing of the partition sets, we need to
allow a suitable re-indexing for at least one of them, so as to match the other one.
M. Grohe and M. Otto
▶Corollary 3.8. Let X ⩾0 be an m×n matrix without null rows or columns, Z = XXt,
Z′ = XtX the associated symmetric matrices with non-zero entries on the diagonal. Then
for ℓ⩾m −1, the matrix ˆX := ZℓX = X(Z′)ℓand its transpose ˆXt = XtZℓ= (Z′)ℓXt are
good and relate the partitions [m] = ˙S
iDi and [n] = ˙S
i induced by Z and Z′, respectively.4
(i) ˆXDiD′
i > 0 for all i, and
(ii) ˆXDiD′
j = 0 for all i ̸= j.
Aside: boolean vs. real arithmetic
Looking at matrices with {0, 1}-entries, we may not only treat them as matrices over R as
we have done so far, but also over other ﬁelds, or as matrices over the boolean semiring
B = {0, 1} with the logical operations of ∨for addition and ∧for multiplication. Though not
even forming a ring, boolean arithmetic yields a very natural interpretation in the context
where we associate non-negative entries with edges, as we did in passage from X to G(X).
The ‘normalisation map’ χ: R⩾0 →{0, 1}, x 7→1 iﬀx > 0, relates the arithmetic of reals
x, y ⩾0 to boolean arithmetic in
χ(x + y) = χ(x) ∨χ(y)
χ(xy) = χ(x) ∧χ(y).
This is the ‘logical’ arithmetic that supports, for instance, arguments used in Observation 3.1: for any real n×n matrix X ⩾0, (XX)ij = P
k XikXkj ̸= 0 iﬀthere is at least
one k ∈[n] for which Xik ̸= 0 and Xkj ̸= 0 iﬀW
k∈[n](χ(Xik) ∧χ(Xkj)) = 1. It is no surprise, therefore, that several of the considerations apparently presented for real non-negative
matrices above, have immediate analogues for boolean arithmetic – in fact, one could argue,
that the boolean interpretation is closer to the combinatorial essence. We brieﬂy sum up
these analogues with a view to their use in the analysis of Lk-equivalence, while the real
versions are related to Ck-equivalence. The boolean analogue of a doubly stochastic matrix
with non-negative real entries is a matrix without null rows or columns.
Also note that the deﬁnitions of irreducibility and X-relatedness are applicable to boolean
matrices without any changes. Observations 3.1 and 3.3 go through (as just indicated), and
so does Lemma 3.2. For Lemma 3.6, one may look at X-related partitions of sets [m] and [n],
where not necessarily n = m, by any boolean matrix X without null rows or columns, and
obtains the relationship between the characteristic vectors as stated there, now in terms of
boolean arithmetic – but of course we do not get any numerical equalities between the sizes
of the partition sets. Lemma 3.7, ﬁnally, applies to boolean arithmetic, exactly as stated.
▶Lemma 3.9. In the sense of boolean arithmetic for matrices with entries in B = {0, 1}:
(a) Any symmetric Z ∈Bn,n induces a unique partition of [n] for which the diagonal minors
induced by the partition sets are irreducible and the remaining blocks null; d, d′ ∈[n] are
in the same partition set if, and only if, in the sense of boolean arithmetic (Zℓ)dd′ = 1
for any/all ℓ⩾n −1.
(b) If two partitions (not necessarily of the same set) with the same number of partition sets
are related by some boolean matrix X ∈Bm,n, then the characteristic vectors (di)i∈I
i)i∈I of the partitions are related by di = Xd′
i = Xtdi in the sense of
boolean arithmetic.
(c) For any matrix X ∈Bm,n without null rows or columns, the symmetric boolean matrices
Z = XXt and Z′ = XtX have diagonal entries 1 and induce partitions that are X/Xtrelated, and agree with the partitions induced by higher powers of Z and Z′ or on the
basis of ZℓX and X(Z′)ℓfor any ℓ∈N. For ℓ⩾m −1, n −1, the partition blocks in Z
Pebble Games and Linear Equations
and Z′ have entries 1 throughout, and ZℓX and X(Z′)ℓhave entries 1 in all positions
relating elements from matching partition sets.
▶Observation 3.10. For a symmetric boolean matrix Z ∈Bn,n with Zdd = 1 for all d ∈[n],
the characteristic vectors di of the partition [n] = ˙S
i∈IDi induced by Z satisfy the following
‘eigenvector’ equation in terms of boolean arithmetic:
(boolean),
for all i ∈I.
Eigenvalues and -vectors
▶Lemma 3.11. If Z ∈Rn,n is doubly stochastic, then it has eigenvalue 1. If Z is doubly
stochastic and irreducible with strictly positive diagonal entries, then the eigenspace for
eigenvalue 1 has dimension 1 and is spanned by the vector d := (1, . . . , 1)t.
Proof. It is obvious that d is an eigenvector of Z with eigenvalue 1.
The eigenspace
with eigenvalue 1 is contained in that of Zn−1, which has entries strictly between 0 and
1 throughout if Z is irreducible with strictly positive diagonal, by Observation 3.1. For
1-dimensionality observe that all entries of Zn−1v are convex combinations of the entries of
v with coeﬃcients strictly between 0 and 1.
▶Corollary 3.12. (a) Let Z ∈Rn,n be doubly stochastic with positive diagonal, and [n] =
iDi a partition with ZDiDj = 0 for i ̸= j and such that the minors ZDiDi are irreducible
for all i. Then the eigenspace for eigenvalue 1 of Z is the direct sum of the 1-dimensional
subspaces spanned by the characteristic vectors di of the partition sets Di.
(b) If Z = XtX ∈Rn,n for some doubly stochastic matrix X, then the eigenspace for
eigenvalue 1 is the direct sum of the spans of the characteristic vectors di from the
unique partition [n] = ˙S
iDi of [n] induced by Z according to Lemma 3.2.
Stable partitions
▶Deﬁnition 3.13. Let A ∈Rn,n and [n] = ˙S
i∈IDi a partition. We call this partition a
stable partition for A if there are numbers (sij)i,j∈I and (tij)i,j∈I such that for all i, j ∈I:
Add′ = sij
Ad′d = tij.
If there are sij such that P
d′∈Dj Add′ = sij for all d ∈Di, we call the partition row-stable;
similarly, for tij such that P
d′∈Dj Ad′d = tij for all d ∈Di, column-stable.
For symmetric A, column- and row-stability are equivalent (with tij = sij).
Note that the row and column sums in the deﬁnition are the Di-components of Adj and
jA = (Atdj)t, respectively. So, for instance, row stability precisely says that for all i the
vector Adi is in the span of the vectors dj.
▶Lemma 3.14. Let A ∈Rn,n commute with some symmetric matrix of the form Z =
XXt ∈Rn,n for some doubly stochastic X ∈Rn,n. Then the partition [n] = ˙S
iDi of [n]
induced by Z according to Lemma 3.2 is stable for A.
Proof. Using the characteristic vectors di of the partition sets again, we have ZAdi =
AZdi = Adi, and thus Adi is an eigenvector of Z with eigenvalue 1. Hence by Corollary 3.12,
it is in the span of the vectors dj, and this means that the partition is row stable. Column
stability is established similarly.
M. Grohe and M. Otto
▶Corollary 3.15. Let A commute with Z = XXt and B commute with Z′ = XtX, where
X is doubly stochastic (cf. Lemma 3.14). Then the partitions induced by Z and Z′, which
are X-related by Lemma 3.7, are stable for A and B, respectively.
Aside: boolean arithmetic
We give a separate elementary proof of the analogue of Lemma 3.14 for boolean arithmetic.
Here the deﬁnition of a boolean stable partition is this natural analogue of Deﬁnition 3.13.
▶Deﬁnition 3.16. A partition [n] = ˙S
i∈IDi is boolean stable for A ∈Bn,n if, in the sense
of boolean arithmetic, P
d′∈Dj Add′ and P
d′∈Dj Ad′d only depend on the set Di for which
Note that boolean stability implies that, for the characteristic vectors di of the partition,
(Adj)d = P
d′∈Dj Add′ is the same for all d ∈Di, so that also here Adj is a boolean linear
combination of the characteristic vectors di.
▶Lemma 3.17. Let A ∈Bn,n commute, in the sense of boolean arithmetic, with some
symmetric matrix of the form Z = XXt ∈Bn,n with entries Zdd = 1 for all d ∈[n]. Then
the partition [n] = ˙S
iDi induced by Z according to Lemma 3.9 is boolean stable for A.
Fractional isomorphism
C2-equivalence and linear equations
The adjacency matrix of graph A is the square matrix A with rows and columns indexed
by vertices of A and entries Aaa′ = 1 if aa′ is an edge of A and Aaa′ = 0 otherwise. By
our assumption that graphs are undirected and simple, A is a symmetric square matrix
with null diagonal. It will be convenient to assume that our graphs always have an initial
segment [n] of the positive integers as their vertex set. Then the adjacency matrices are in
Bn,n ⊆Rn,n. Throughout this subsection, we assume that A and B are graphs with vertex
set [n] and with adjacency matrices A, B, respectively. It will be notationally suggestive to
denote typical indices of matrices a, a′, . . . ∈[n] when they are to be interpreted as vertices
of A, and b, b′, . . . ∈[n] when they are to be interpreted as vertices of B.
Recall (from the discussion in the introduction) that two graphs A, B are isomorphic if,
and only if, there is a permutation matrix X such that AX = XB. We can rewrite this as
the following integer linear program in the variables Xab for a, b ∈[n].
b′∈[n] Xab′ = P
a′∈[n] Xa′b = 1,
a′∈[n] Aaa′Xa′b = P
b′∈[n] Xab′Bb′b,
for all a, b ∈[n].
Then A and B are isomorphic if, and only if, ISO has an integer solution.
▶Deﬁnition 4.1. Two graphs A, B are fractionally isomorphic, A ≈B, if, and only if, the
system ISO has a real solution.
So graphs are fractionally isomorphic if, and only if, there is a doubly stochastic matrix
X such that AX = XA. Note that fractionally isomorphic graphs necessarily have the same
number of vertices (this will be diﬀerent for the boolean analogue, which cannot count).
Pebble Games and Linear Equations
A stable partition of the vertex set of an undirected graph is a stable partition [n] = ˙S
for its adjacency matrix in the sense of Deﬁnition 3.13. The characteristic parameters for a
stable partition [n] = ˙S
i∈IDi for A are the numbers sij = sA
ij such that sij = P
d′∈Dj Add′
for all d ∈Di. (As A is symmetric, the parameters tij of Deﬁnition 3.13 are equal to the sij.)
We call two stable partitions ˙S
i∈IDi for a matrix A and ˙S
i for a matrix B equivalent
if I = J and |Di| = |D′
i| for all i ∈I and sA
ij and for all i, j ∈I.
▶Lemma 4.2. A and B are C2-equivalent if, and only if, there are equivalent stable partitions
i∈IDi for A and ˙S
Proof sketch. The partition of the elements A and B according to their C2-type yields
equivalent stable partitions (two elements have the same C2-type if they satisfy the same
C2-formulae with one free variable). For the converse, it can be shown that equivalent stable
partitions give player II a winning strategy in the bijective 2-pebble game.
▶Theorem 4.3 (Ramana–Scheinerman–Ullman). Two graphs are C2-equivalent if, and only
if, they are fractionally isomorphic.
Proof. In view of Lemma 4.2, it suﬃces to prove that A and B have equivalent stable
partitions if, and only if, they are fractionally isomorphic.
For the forward direction, suppose that we have equivalent stable partitions ˙S
i∈IDi for A
i for B. For all a ∈Di, b ∈D′
j we let Xab := δ(i, j)/ni, where ni := |Di| = |D′
(Here and elsewhere we use Kronecker’s δ function deﬁned by δ(i, j) = 1 if i = j and
δ(i, j) = 0 otherwise.) An easy calculation shows that this deﬁnes a doubly stochastic matrix
X with AX = XB, that is, a solution for ISO.
For the converse implication, suppose that X is a doubly stochastic matrix such that
AX = XB. Since A and B are symmetric, also XtA = BXt, which implies that A commutes
with Z := XXt and B with Z′ := XtX.
From Lemma 3.14 and Corollary 3.15, the partitions [n] = ˙S
i∈IDi and [n] = ˙S
that are induced by the symmetric matrices Z and Z′ are X-related and stable for A and for
B, respectively. We need to show that |Di| = |D′
i| and that the partitions also agree w.r.t.
the parameters sij.
By Lemma 3.6 we have |Di| = |D′
i| and di = Xd′
i = Xtdi, where di and d′
i ∈I are the characteristic vectors of the two partitions. Thus for all i, j ∈I,
j = (Xtdi)tBXtdj = dt
iXBXtdj = dt
iAXXtdj = dt
iAZdj = dt
where the last equality follows from the fact that dj is an eigenvector of Z with eigenvalue
1 by Corollary 3.12. Note that dt
iAdj is the number of edges of A from Di to Dj. By
stability of the partition, we have sA
iAdj/|Di| and similarly sB
L2-equivalence and boolean linear equations
W.r.t. an adjacency matrix A ∈Bn,n, a boolean stable partition [n] = ˙S
i∈IDi has as
parameters just the boolean values ιA
ij deﬁned by ιA
ij = 0 if ADiDj = 0 and ιA
ij = 1 otherwise.
Boolean (row-)stability of the partition for A implies that ιA
ij = 1 if, and only if, for each
individual d ∈Di there is at least one d′ ∈Dj such that Add′ = 1.
To capture the situation of 2-pebble game equivalence, though, we now need to work
with similar partitions that are stable both w.r.t. A and w.r.t. to the adjacency matrix Ac of
the complement of the graph with adjacency matrix A. Here the complement of a graph
M. Grohe and M. Otto
A is the graph Ac with the same vertex set as A obtained by replacing edges by non-edges
and vice versa. Hence Ac
aa′ = 1 if Aaa′ = 0 and a ̸= a′, and Ac
aa′ = 0 otherwise. While a
partition in the sense of real arithmetic is stable for A if, and only if, it is stable for Ac, this
is no longer the case for boolean arithmetic. Let us call a partition that is boolean stable for
both A and Ac, boolean bi-stable for A.
Then the following captures the situation of two graphs that are 2-pebble game equivalent.
We note that 2-pebble equivalence is a very rough notion of equivalence, if we look at just
simple undirected graphs – but the concepts explored here do have natural extensions to
coloured, directed graphs, and form the basis for the analysis of k-pebble equivalence, which
is non-trivial even for simple undirected graphs.
L2-equivalence of two graphs does not imply that the graphs have the same size. In the
following, we always assume that A, B are graphs with vertex sets [m], [n] respectively and
that A ∈Bm,m and b ∈Bn,n are their adjacency matrices. We call two bi-stable partitions
i∈IDi for A (and Ac) and [n] = ˙S
i for B (and Bc) b-equivalent if I = J
ij and ιAc
and for all i, j ∈I. Note that b-equivalence does not imply
|Di| = |D′
▶Lemma 4.4. A and B are L2-equivalent if, and only if, there are b-equivalent bi-stable
partitions [m] = ˙S
i∈IDi for A and [n] = ˙S
▶Deﬁnition 4.5. A and B are boolean isomorphic, A ≈bool B, if there is some boolean
matrix X without null rows or columns such that AX = XB and AcX = XBc.
▶Theorem 4.6. Two graphs are L2-equivalent if, and only if, they are boolean isomorphic.
Relaxations in the style of Sherali–Adams
In this section we reﬁne the connection between the Sherali–Adams hierarchy of LP relaxation
of the integer linear program ISO to equivalence in the ﬁnite variable counting logics.
Throughout this section, our parameter k ⩾2 is the number of variables available in the
logics Ck or Lk. As before, A and B are graphs with vertex sets [m] and [n], respectively,
and A and B are their adjacency matrices.
The level-(k −1) Sherali–Adams relaxation of the integer linear program ISO is the
following linear program in the variables Xp for all p ⊆[m] × [n] of size |p| < k. We write
pbab for the extension of p by the pair (a, b) (which need not be a proper extension).
b′ Xpbab′ = P
for ℓ:= |p| + 1 < k, a ∈[m], b ∈[n]
Cont(ℓ) for ℓ< k
a′ Aaa′Xpba′b = P
b′ Xpbab′Bb′b
for ℓ:= |p| + 1 < k, a ∈[m], b ∈[n]
Comp(ℓ) for ℓ< k
Xp ≥0 for |p| ≤k −1
We call the equations Comp(ℓ) for 1 ≤ℓ< k comaptibility equations and the equations
Cont(ℓ) for 0 ≤ℓ< k continuity equations, where we let Cont(0) be the equation X∅= 1.
We will also consider these equations independently of ISO(k −1), as in the next lemma.
Pebble Games and Linear Equations
▶Lemma 5.1. If A ≡k
C B, then there is a non-negative solution (Xp) for the combination of
the continuity equations Cont(ℓ) of levels ℓ⩽k (!) with the compatibility equations Comp(ℓ)
of levels ℓ< k.
Proof. For tuples a ∈[m]ℓand b ∈[n]ℓof length ℓ≤k, we write tp(a) = tp(b) if A, a and
B, b satisfy the same Ck-formulae ϕ(x) (equality of Ck-types). We write p = ab to indicate
that p consist of the pairs aibi of corresponding entries in these tuples.
To deﬁne the solution, we let X∅:= 1. For p = ab, we let Xp = 0 if tp(a) ̸= tp(b), and
we let Xp := 1/#b′(tp(a) = tp(b′)) otherwise. Tedious but straightforward calculations
show that this indeed deﬁnes a solution of the desired equations.
Thus in particular, if A and B are Ck-equivalent then the system ISO(k−1) has a solution.
Unfortunately, the converse does not hold (as we will see later). The solvability of ISO(k −1)
only implies a weaker equivalence between A and B, which we call C<k-equivalence. It is
deﬁned in terms of a game, the weak bijective k-pebble game on A, B. The game is played by
two players. Positions of the game are sets p ⊆[m] × [n] of size |p| ≤k −1, and the initial
position is ∅. A single round of the game, starting in position p, is played as follows.
1. If |p| = k −1, player I selects a pair ab ∈p. If |p| < k −1, he omits this step.
2. Player II selects a bijection between [m] and [n]. If no such bijection exists, i.e., if m ̸= n,
the game ends and player II loses.
3. Player I chooses a pair a′b′ from this bijection.
4. If p+ := pba′b′ is a local isomorphism then the new position is
(p\ab)ba′b′
if |p| = k −1,
if |p| < k −1.
Otherwise, the play ends and player II loses.
Player II wins a play if it lasts forever. Structure A and B are C<k-equivalent, A ≡<k
player II has a winning strategy for the game.
Note that the weak bijective k-pebble game requires more of the second player than
the bijective (k −1)-pebble game, because p+ rather than just p′ is required to be a local
isomorphism. On the other hand, it requires less than the bijective k-pebble game: the
bijective k-pebble game precisely requires the second player to choose the bijection without
prior knowledge of the pair ab that will be removed from the position. A strategy for player
II in the weak version is good for the usual version if it is fully symmetric or uniform w.r.t.
the pebble pair that is going to be removed. However, this is only relevant if k ≥3. The
weak bijective 2-pebble game and the bijective 2-pebble game are essentially the same.
The core of the proof of the following is analogous to that of Theorem 4.3.
▶Theorem 5.2. A ≡<k
B if, and only if, ISO(k −1) has a solution.
▶Remark 5.3. The weak bijective k-pebble game is equivalent to a bisimulation-like game
with k −1 pebbles where in each round the ﬁrst player may slide a pebble along an edge of
one of the graphs and the second player has to respond by sliding the corresponding pebble
along an edge of the other graph. In this version, the game coresponds to the (k −1)-pebble
sliding game introduced by Atserias and Maneva .
We will see in the next section that C<k-equivalence neither coincides with Ck−1equivalence nor with Ck-equivalence. Thus it remains to give a characterisation of Ckequivalence. By the previous theorem and the observation that Ck-equivalence is situated
between C<k-equivalence and C<k+1-equivalence, we know that we need a linear program
M. Grohe and M. Otto
that is “between” ISO(k −1) and ISO(k). Surprisingly, we obtain such a linear program by
combining the two in a very simple way: we take the continuity equations from ISO(k) and
the compatibility equations from ISO(k −1). Thus the resulting linear program, which we
call ISO(k −1/2), has variables Xp for all p ⊆[m] × [n] of size |p| ≤k and consists of the
equations Cont(ℓ) for ℓ≤k and the equations Comp(ℓ) for ℓ≤k −1, together with the
non-negativity constraints Xp ≥0. So Lemma 5.1 proves one implication of the theorem.
▶Theorem 5.4. A ≡k
C B if, and only if, ISO(k −1/2) has a solution.
Boolean arithmetic and Lk-equivalence
We saw in Section 4.2 that equations, which are direct consequences of the basic continuity
and compatibility equations w.r.t. the adjacency matrices A and B, may carry independent
weight in their boolean interpretation. This is no surprise, because the boolean reading is
much weaker, especially due to the absorptive nature of ∨, which unlike + does not allow for
inversion. AX = XB for doubly stochastic X and A, B ∈Bn,n implies AcX = XBc.
We now augment the boolean requirements by corresponding boolean equations that
(a) compatibility also w.r.t. Ac and Bc, as in boolean fractional isomorphism,
(b) the new constraint Xp = 0 whenever p is not a local bijection.
In the presence of the continuity equations, which force monotonicity, it suﬃces for (b) to
stipulate Xaa′bb′ = 0 for all a, a′ ∈[m], b, b′ ∈[n] such that not a = a′ ⇔b = b′. This is
captured by the constraint Match(2) below. So we now use the following boolean version of
the Sherali–Adams hierarchy ISO(k −1) and ISO(k −1/2) for k ≥2.
B-ISO(k −1)
b′ Xpbab′ = P
for |p| < k, a ∈[m], b ∈[n]
Cont(ℓ) for ℓ< k
Xabbab′ = 0 = Xabba′b
for a ̸= a′ ∈[m], b ̸= b′ ∈[n]
a′ Aaa′Xpba′b = P
b′ Xpbab′Bb′b
for |p| < k −1, a ∈[m], b ∈[n]
Comp(ℓ) for ℓ< k
aa′Xpba′b = P
b′ Xpbab′Bc
for |p| < k −1, a ∈[m], b ∈[n]
Comp(ℓ)c for ℓ< k
For B-ISO(k −1/2) we require Cont(ℓ) for all ℓ⩽k, i.e., additionally for ℓ= k.
▶Remark 5.5. B-ISO(k −1) and B-ISO(k −1/2) are systems of boolean equations, and
the reader may wonder whether they can be solved eﬃciently. At ﬁrst sight, it may seem
NP-complete to solve such systems (just like boolean satisﬁability). However, our systems
consist of “linear” equations of the forms P
i∈I Xi = P
j∈J Xj and P
i∈I Xi = 0 (which is
actually a special case of the ﬁrst for J = ∅) and P
i∈I Xi = 1. It is an easy exercise to prove
that such systems of linear boolean equations can be solved in polynomial time.
Pebble Games and Linear Equations
{1} {2} {3}
{2,3}{1,3}{1,2}
Figure 1 The Cai–Fürer–Immerman gadgets.
Figure 2 Structure A.
We deﬁne a weak k-pebble game as a straightforward adaptation of the weak bijective
k-pebble game to the setting without counting, and we denote weak k-pebble equivalence as
▶Theorem 5.6. W.r.t. boolean arithmetic:
(a) B-ISO(k −1) has a solution if, and only if, A ≡<k
(b) B-ISO(k −1/2) has a solution if, and only if, A ≡k
Based on a construction due to Cai, Fürer, and Immerman , for k ⩾3 we construct graphs
showing that A ≡<k
C B, and that A ≡k−1
▶Example 6.1. For every k ⩾3, there are graphs A and B such that A ≡k−1
We describe the graphs A and B for k = 4; the adaptation of the construction to
other k is straightforward. The graphs are the straight and the twisted version of the
Cai–Fürer–Immerman companions of the 4-clique.
We use copies of the standard degree 3 gadget H3 and its dual ¯H3 shown in Figure 1. We
think of these as coloured graphs where the colours distinguish inner vertices (marked I) as
well as outer vertices (marked O) as well as the three pairs of outer vertices. This is without
loss of generality, since we may eliminate colours, e.g., by attaching simple, disjoint paths of
diﬀerent lengths to the members of each group of vertices. The non-trivial automorphisms of
this decorated variant of H3 and ¯H3 precisely allow for simultaneous swaps within exactly
two pairs of outer vertices.
Let A consist of four decorated copies of H3, copies a, b, c, d say, that are linked by edges
in corresponding outer nodes as shown in Figure 2. B consists of three decorated copies of
H3 (labelled a, b, c) and one of ¯H3 (labelled d), and linked in the same manner.
It can be shown that player I has a winning strategy in the weak bijective 4-pebble game
on A, B, whereas player II has a winning strategy in the bijective 3-pebble game.
M. Grohe and M. Otto
▶Example 6.2. For every k ⩾3, there are graphs A and B such that A ≡<k
B but A ̸≡k
We describe the graphs for k = 3. We use variants of A and B as in the last example,
but with one marked inner node: in both A and B we mark the inner node (a, ) by a
new colour (which can be eliminated by attaching a path of some characteristic length, as
observed above). We denote these modiﬁed structures as A∗and B∗.
Then it can be shown that player I has a winning strategy in the bijective 3-pebble game
on A∗, B∗, whereas player II has a winning strategy in the weak bijective 3-pebble game.