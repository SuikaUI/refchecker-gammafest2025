Effective Multi-Query Expansions: Collaborative Deep Networks for Robust
Landmark Retrieval
Yang Wang, Xuemin Lin, Lin Wu, Wenjie Zhang
Given a query photo issued by a user (q-user), the
landmark retrieval is to return a set of photos with
their landmarks similar to those of the query, while
the existing studies on the landmark retrieval focus
on exploiting geometries of landmarks for similarity matches between candidate photos and a query
photo. We observe that the same landmarks provided by different users over social media community may convey different geometry information depending on the viewpoints and/or angles,
and may subsequently yield very different results.
In fact, dealing with the landmarks with low quality shapes caused by the photography of q-users is
often nontrivial and has seldom been studied. In
this paper we propose a novel framework, namely
multi-query expansions, to retrieve semantically robust landmarks by two steps. Firstly, we identify
the top-k photos regarding the latent topics of a
query landmark to construct multi-query set so as
to remedy its possible low quality shape . For this
purpose, we signiﬁcantly extend the techniques of
Latent Dirichlet Allocation. Then, motivated by the
typical collaborative ﬁltering methods, we propose
to learn a collaborative deep networks based semantically, nonlinear and high-level features over
the latent factor for landmark photo as the training set, which is formed by matrix factorization
over collaborative user-photo matrix regarding the
multi-query set. The learned deep network is further applied to generate the features for all the other
photos, meanwhile resulting into a compact multiquery set within such space. Then, the ﬁnal ranking scores are calculated over the high-level feature space between the multi-query set and all other
photos, which are ranked to serve as the ﬁnal ranking list of landmark retrieval.
Extensive experiments are conducted on real-world social media
data with both landmark photos together with their
user information to show the superior performance
over the existing methods, especially our recently
proposed multi-query based mid-level pattern representation method [Wang et al., 2015a].
Introduction
The popularity of personal digital photography has led to an
exponential growth of photos with landmarks. The current social media data set characterize both the landmark photos and
associated uploaded user information. e.g., panoramio.com
Figure 1: A q-user has issued a biased landmark photo of Eiffel
Tower in Paris in the left most photo. Multiple users with the same
latent topic as the q-user are selected to recommend three more landmark photos taken at the same place, that complement the given
query landmark to construct a multi-query set.
and Picasa Web Album1. This highly demands for the research in the area of efﬁcient and effective retrieval of photos
based on landmarks (e.g., tower and churches), namely landmark retrieval. Given a query photo, the landmark retrieval
returns the set of photos with their landmarks highly similar
to that of the query photo.
Unlike the conventional photo retrieval that performs
within the low-level feature spaces (e.g., color and texture),
the landmark retrieval is conducted based on geometry information of landmarks. A number of paradigms [Doersch
et al., 2012; Fang et al., 2013; Hays and Efros, 2008] have
been proposed to perform the landmark retrieval under the
heterogeneous feature spaces, including the paradigms based
on patch level region features [Doersch et al., 2012], midlevel attributes [Fang et al., 2013], and the combination of
low-level features [Hays and Efros, 2008].
Among the existing techniques, there is one critical assumption: a high quality of query photo is always provided;
that is, the landmark captured from a query photo always provides a shape with high quality. Nevertheless, such an assumption is not always true in practice. Indeed, the landmark
of a query photo may provide shape with low quality due to
various reasons, such as personal preference, photography,
etc. For example, as illustrated in Fig. 1, the left most photo
taken by a q-user gives the landmark Eiffel Tower with a very
low quality shape . Consequently, the existing methods may
not be able to return the set of photos that contain the Eiffel Tower since the geometry quality of the landmark in the
1picasa.google.com
 
Figure 2: The ﬂow chart of our framework. Our framework comprises the following main phases: 1) query landmark based topic and
user community discovery; 2) select multiple landmark photos from user-query photo matrix to form a multi-query set; and 3) Learning a
collaborative deep network based feature representation to characterize the multi-query set and other landmark photos in the database (see
Fig. 4), and calculate the ranking score between multi-query set and each photo in the database, leading to the ﬁnal ranking based retrieval
query photo is too low.
Motivated by this, in this paper we propose a novel method,
depicted in Fig. 2, for a robust landmark retrieval through a
novel paradigm based on multi-query expansions over the social media data set with the information for both users and
their uploaded landmark photos. Firstly, we propose to identify a set of photos that share the similar latent topics with
the query landmark by adopting the Latent Dirichlet Allocation (LDA) techniques [Blei et al., 2003]. Then, we propose
a localized matrix factorization technique over the user-photo
collaborative matrix that encodes the information from the
selected photos, where the latent factor regarding landmark
photos can be obtained. The k-mean clustering algorithm is
subsequently applied to the landmark photo latent factor to
generate the clustering result, with each cluster as one pseudo
Remark. we remark that clustering is performed over latent
factors for landmark photo rather than original data objects,
as indicated by collaborative ﬁltering methods, such as [Shi
et al., 2014], the latent factors can encode rich underlying
similarity so that the ideal clustering result can be achieved.
The deep convolutional Neural Network is then trained under all pseudo classes so that the high-level semantic feature
can be extracted via deep network over both query photo and
all other landmark photos.
Note that we can select the top-s photos from the multiquery set by calculating the similarity score between the
query landmark photo and all other landmark photos within
the high-level deep feature space, resulting into a more compact yet encoding similar latent topics as the query landmark
photo. We simply combine all the high-level feature representations for all the photos in the multi-query set to be the ﬁnal
representation, which is utilized to calculate the ﬁnal ranking
similarity score over all landmark photos in the database.
Remark. We remark that our work is a non-trivial extension
of our previous published work [Wang et al., 2015a],
• where a mid-level pattern representation over the expanded multi-query set is proposed for robust landmark
retrieval. Following [Wang et al., 2015a], our method
exploits not only the information regarding the landmark
photos but also the associated user information for multiquery expansion over robust landmark retrieval. Different from [Wang et al., 2015a] by learning a mid-level
pattern representation for landmark retrieval, we propose to learn high-level semantic feature over the pseudo
classes by clustering the latent factors regarding landmark photos yielded from the matrix factorization over
the collaborative user-photo matrix.
Based on [Wang et al., 2015a], we features the following
novel contributions in this paper.
• Unlike learning the mid-level pattern representations in
[Wang et al., 2015a], we learn the high-level deep features to tackle the problem of landmarks in query photos with possibly low quality shapes , over both multiquery expansions and landmark photos. To the best of
our knowledge, we are the ﬁrst to learn the deep features
for this problem.
• Unlike [Wang et al., 2015a] by exploiting user information to perform multi-query expansion only, We train the
deep network over the pseudo classes corresponding to
the clusters over the latent factors from the user-photo
matrix via matrix factorization.
• As the matrix factorization over user-photo matrix is
categorized as collaborative ﬁltering ﬁeld, hence we
propose a collaborative deep network feature learning
method for both multi-query set and all other landmark
photos, which are further utilized to conduct landmark
retrieval within such high-level feature space. We conducted more experiments than [Wang et al., 2015a] over
real-world landmark photo datasets, validating the effectiveness of our approach.
The rest of this paper is structured as follows. We review
the related work in Section 2. Then, we describe our proposed technique in Section 3. We experimentally validate
the performance of our approach in Section 4, and conclude
this paper in Section 5.
Related Work
In this section, we mainly review the related work on landmark retrieval and related query argumentation technique.
Feature Learning for Landmark Retrieval
The increasing amount of landmark photos has resulted in
numerous methods for landmark retrieval [Hays and Efros,
2008; Zhu et al., 2008; Doersch et al., 2012; Fang et al.,
2013]. Hays et al. [Hays and Efros, 2008] presented a feature matching approach to return the K nearest neighbors with
respect to the query landmark photo where a query photo
and photos in database are represented by aggregating a set
of low-level features to perform landmark retrieval. Zhu et
al. [Zhu et al., 2008] proposed to learn the landmark feature
by combining low-level features while assisted with Support
Vector Machine (SVM). In [Doersch et al., 2012], a region
based recognition method is proposed to detect discriminative
landmark regions at patch level, which is seen as the feature
for landmark retrieval. To augment semantic interpretation
on landmark representation, Fang et al. [Fang et al., 2013]
presented an effective approach, namely GIANT, to discover
both discriminative and representative mid-level attributes for
landmark retrieval. Zhu et al. [Zhu et al., 2015b] propose
a hypergraph [Wang et al., 2014a] model for landmark retrieval.
However, these approaches are still using a single query
photo for landmark retrieval whilst our approach is focusing
on mining robust patterns of landmark photos from an expanded multi-query set. Wang et al. [Wang et al., 2015a]
proposed to learn a mid-level pattern representations for
landmark retrieval over multi-query set, which applied the
KRIMP [Vreeken et al., 2011] algorithm and Minimumdescription-length (MDL) principle [Grunwald, 2007] to
mine the compact pattern representation. Unlike that, we propose a deep network based high-level features for landmark
retrieval. As a related problem, several scene categorization
methods e.g., [Zhou et al., 2014; Wu et al., 2015] via deep
feature learning problem is also proposed. Besides the different problem from ours, we also exploited the user information
for deep feature learning for landmark retrieval.
There are abundant related work towards feature learning
via dictionary learning [Wu et al., 2016]. For instance, Zhu
et al. [Zhu and Shao, 2014] proposed a weakly-supervised
cross-domain dictionary learning method is proposed to learn
a reconstructive, discriminative and domain adaptive dictionary. To this end, the weakly labeled data is utilized from the
source data set to span the coverage of intra-class diversity
over the training data to gain discriminative power. However,
they have not studied the problem of landmark retrieval.
Query Argumentation Technique
In [Chum et al., 2007], a query expansion technique is
brought into the visual domain in which a strong spatial constraint between a query image and each result allows for
an accurate veriﬁcation of each return, improving image retrieval performance. This simple method of well-performing
query expansion is referred to as Average Query Expansion
[Chum et al., 2007] (AQE) where given a query image, images are ranked using tf-idf scores and corresponding visual
words in these images are averaged together with the query
visual words, and this resulting query expanded visual word
vector is recast to be a new query to re-query the database.
Observing that AQE is lack of discrimination, Arandjelovic
et al. [Arandjelovic and Zisserman, 2012] enhanced it using
a linear SVM to discriminatively learn a weight vector for requerying yields a signiﬁcant improvement over the standard
average query expansion method, called DQE. The most related work to ours is [Fernando and Tuytelaars, 2013] (PQE),
where a query expansion approach for a particular object retrieval is presented. Our method is different from them in
terms of multi-query construction.
Zhu et al. [Zhu et al.,
2015a] propose to perform landmark classiﬁcation with a hierarchical multi-modal exemplar features. There are also research [Kennedy and Naaman, 2008] aiming at developing
the feature representations for diverse landmark search.
These methods are commonly based on the idea that those
particular multiple queries are manually selected or simply
retrieved from top-k similar items whilst we automatically
determine helpful queries by exploring the latent topics of
query landmark as well as the informative user communities.
Besides, previous query expansion pipelines are not applicable in the context of social media networks, which cannot
be addressed by simple variations of methods in literature.
To address the limitation, Wang et al. [Wang et al., 2015a]
proposed a multi-query expansion technique to learn a robust
mid-level pattern representation. Based on that, we propose
to learn high-level deep feature over multi-query set, which
is superior to the mid-level representation in [Wang et al.,
Geo-tagging by Exploring User Community
Geo-tagging refers to adding geographical identiﬁcation
metadata into various multimedia data such as images [Hauff
and Houben, 2012] in websites, blogs, and photo-sharing
web-services [Amitay et al., 2004; Luo et al., 2011; Zheng
et al., 2009].
Associating time and location information
(latitude/longitude) with pictures can facilitate geotaggingenabled information services in terms of ﬁnding locationbased news, photos, or other resources [Arslan et al., 2010;
Wu and Cao, 2010; Kalogerakis et al., 2009; Wang et al.,
2014b]. There are also a number of approaches [Ji et al.,
2012] trying to learn the location based visual codebook for
landmark search. Similar to our method, such research area
also explore the user communities. However, this kind of research is apparently different from landmark retrieval studied
in this paper.
Our Method
To the best of our knowledge, we are the ﬁrst to learn the deep
network based high-level features over latent factors regarding landmark photos for landmark retrieval. To achieve that,
the user information are also explored, which can be easily
obtained from the social media data.
Unlike the previous work, inspired by [Krizhevsky et al.,
2012], our proposed method aims at learning a deep convolutional neural network based high-level features over landmark
latent factor obtained by performing matrix factorization over
collaborative user-photo matrix corresponding to the multiquery set. Then the deep features for both the multi-query set
and landmark photos can be generated for further landmark
retrieval within high-level deep feature space.
It is well known that learning deep network features plays
a crucial role for a wide range of applications. Shao et al.
[Shao et al., 2014b] proposed a multi-spectral neural networks (MSNN) is by projecting multiple penultimate layer of
the deep network, namely multi-columns deep network, into
multi-spectral smooth embedding to achieve the complementary multi-view spectral relationship. To this end, an effective
multi-view alignment strategy is proposed. As a by-product,
the smooth low-dimensional manifold embedding enables it
to be robust to possible noise corruptions in raw feature representations. A multi-objective genetic program with four-layer
structure is proposed in [Shao et al., 2014a] to automatically
generate domain adaptive global feature descriptors for image classiﬁcation. A typical yet simple deep network [Chan
et al., 2015] is learned for image classiﬁcation, by employing
PCA to learn multi-stage ﬁlter banks, followed by simple binary hashing and block histograms for indexing and pooling.
Some multi-view feature fusion methods [Wang et al., 2015c;
Wang et al., 2013; Wang et al., 2017; Wang et al., 2015b;
Wang et al., 2016b; Wu et al., 2013; Wu and Wang, 2017;
Wang et al., 2016a] have also been proposed.
Our method features the following non-trivial differences
from the above deep network research.
by exploiting the
user information associated with the landmark photos to
form the landmark photo clusters i.e., pseudo-classes, upon
which we further learn the deep features for landmark retrieval over such latent factors.
We seek the latent cluster representations for user-landmark matrix via matrix factorization, which characterize more useful information than
original user-landmark matrix. Based on the above, given
a query landmark photo to be issued, we expand the multilandmark photo to augment the single query candidate to address the possibly biased query via the Latent Dirichlet Allocation (LDA) for ﬁnal retrieval.
The Proposed Technique
In this section, we formally present our technique consists of
the following components: The ﬁrst stage is about latent topic
discovery on landmark photos via LDA model, and multiquery expansion based on topic related user groups. The second stage is to train a deep network suitable for landmark
photos with user priors such that given input of a multi-query
set offered by the ﬁrst stage, deep features can be extracted
regarding both the landmark database as well as the multiple
complementary query photos, upon which the deep feature of
each photo in the multi-query set are aggregated into overall discriminative representations for retrieval over landmark
Latent Topics and User Group Discovery
As stated above, our ﬁrst stage is to detect the latent topics
over landmark photos including query landmark. We ﬁrst
introduce some preliminaries on notations and deﬁnitions in
LDA model.
Preliminaries about LDA
Formally, given a set of users U, each of which is associated with their landmark photos. We assume these observed
photos can be grouped into clusters as per their latent topics,
where each latent topic is related to a set of landmarks; e.g.,
an photo containing the landmark “Eiffel tower” may belong
to the topic “architecture”; the landmark “Himalayas” may
belong to the topic “mountain”. Suppose a set of topics for
a query are detected, each photo can then be modeled as a
probabilistic distribution over these topics. Based on that, it
can be seen as a generative model where each user album,
a.k.a document i, is composed of a number of topics, and the
generation for each photo is probabilistically determined by
the topics of the album.
It remains a challenge to recommend landmark photos
that can complement a query landmark because it is unable
to model their similarities by referring to visual appearance
The LDA model of graphical representation on
landmark photo distributions. A topic distribution θi (e.g.,
“architecture” and “mountain”) on album i is chosen by
Dirichlet prior Dir(α), and photo distribution φz on topic z is
chosen by Dir(β). Then each photo ω from i can be modeled
as a distribution on its topic zij (ω ∼Multinomial(φzij))
with topic zij characterized by zij ∼Multinomial(θi).
which are displaying dramatic changes. To this end, we propose to discover latent topics over the dataset of landmark
photos, where the photos sharing the same topics can be clustered together to constitute an augmented multi-query set. We
utilized color SIFT descriptors [Bosch et al., 2006] to encode
landmark photos, where LDA is further latent topic detection. In this step, we use Latent Dirichlet Allocation (LDA)
[Blei et al., 2003] which allows sets of observations (landmark photos) to be explained by unobserved groups that explain how much of the landmark photos are similar. In our
case, photos are regarded as observations that are collected
into user albums (a.k.a documents in LDA), and it posits that
each document is a mixture of a small number of topics such
that each photo’s creation is attributable to one of the document’s topics. Thus, the topic model of LDA can be used to
explain the relatedness of landmark photos which cannot be
described reliably by feature descriptors. Once latent topics
are discovered w.r.t user album, we can construct a user group
that consists of users who upload landmark photos sharing
similar topics to the query landmark, from which multi-query
expansion can be performed (Section 3.2).
Now, we are ready to reformulate the problem of query
landmark topic discovery into a LDA model. Let α and β be
the parameter of the Dirichlet prior on the per-document (album) topic distributions and the per-topic word (photo) distribution. θi is the topic distribution for album i, and φz denotes
the photo distribution for topic z. zij is the topic for the jth photo in album i, and ωij is the speciﬁc photo. The ωij
are the only observable variables, and the other variables are
latent variables. In fact, φ is a Z × V Markov matrix (Z is
number of topics considered in LDA, and V is the dimension
of the vocabulary, i.e., number of photos), and each row of
which denotes the photo distribution of a topic. Thus, LDA
assumes a generative process for a corpus D consisting of |D|
user albums each of length Ni:
1. Choose the number of topics: Z
2. Choose θi ∼Dir(α), where i ∈{1, . . . , |D|}, and
Dir(α) is the Dirichlet distribution for parameter α
3. Choose φz ∼Dir(β), where z ∈{1, . . . , Z}
4. For each of the photo position i, j where j
{1, . . . , Ni}, and i ∈{1, . . . , |D|}
• Choose a topic zij ∼Multinomial(θi)
• Choose an photo ωij ∼Multinomial(φzij).
Fig.3 depicts a graphical model for this representation.
As a result, the output of LDA over D, denoted as
LDA(D), can be seen as a partition of D into multiple groups,
each of which contains photos characterizing the same latent
Remark. To detect the latent topic of the query landmark,
we need to perform LDA over the entire photo database, and
such process is performed via an off-line fashion in our implementation.
Detecting Latent Topics for A Landmark Query
We propose to detect potential latent topics for a landmark
query such that highly relevant photos as per each topic w.r..t
the query can be clustered, from which a multi-query set can
be constructed. Recall that each topic z has the probability
of generating photos, and for the query q, its probability distribution over z is denoted as P(q|z). Commonly, we set a
probability threshold λ to decide the candidate topics for the
query q. That is, P(q|z) ≥λ indicates that z could be one
candidate topic for q. Then, we have two cases regarding the
probability threshold λ:
1. if λ is small, we may generate a lot of candidate topics,
while many of them might be non-relevant to q.
2. if λ is large, the size of topic set would be quite small,
which may not be inclusive to involve true topics for q.
Thus, we learn a trade-off value for λ from empirical studies, which is critical to decide the topic set regarding the query
q. Once the query topic set is determined, it is plausible to
recommend a number of photos sharing the same topics to q.
To this end, we propose to utilize user communities to assist
multi-query set construction. Speciﬁcally, an user is seen to
be related to the query user, if he/she uploads photos sharing
at least one of the topics associated with an photo uploaded
by the query user. Hence, an user-photo matrix can be constructed as M ∈R|U|×|J| where U and J denote the user
and photo set, respectively. |U| and |J| denote the number of
users and photos, and uq ∈U represents the query user. In
M, we have M(u, j) = 1 if a user u ∈U uploaded a photo
j into J, and M(u, j) = 0, otherwise. In what follows, we
will elaborate the process of selecting top-K photos to complement the query q to be a robust multi-query set.
Multi-Query Expansion
To discover an appropriate set of photos for query landmark expansion, we perform non-negative matrix factorization [Koren et al., 2007] on the user-photo matrix M, where
the users (include uq) and relevant photos are detected by
LDA described in Section 3.1. By factorizing M into a lowerdimensional latent space, each photo’s possibility of being
recommended to uq is computed based on the resulting factorization. Then, photos with K highest relevant scores (high
possibility to share same topics w.r.t the query) are selected,
together with the original query, to form a robust multi-query
Speciﬁcally, we perform the non-negative matrix factorization on M by minimizing the objective function below.
P,V ||M −PV ||F , P ≥0, V ≥0,
where || · ||F denotes the Frobenius norm. Two low-rank factor matrices P ∈R|U|×L and V ∈RL×|J| are obtained by
solving Eq.(1), where P models the mapping of users in the
low-dimensional latent space with L dimensions, and V de-
ﬁnes the mappings of photos to the same latent space. That is,
each user u is represented as the u-th row vector of P denoted
by P(uq, ·), while each photo j is encoded by the j-th column
vector of V denoted by V (·, j). We reformulate Eq. (1) into
the following optimization problem
P,V ||M −PV ||2
F + β .
As presented in our earlier work [Wang et al., 2015a], relevant photos can be selected by computing their inner product
with the query user vector in the factorized space. Specifically, for uq ∈U, a conﬁdence score can be computed to
determine if photo j will be recommended to uq through the
inner product of P(uq, .) and V (., j):
S(uq, j) =< P(uq, ·), V (·, j) > .
Through the computation of Eq. (3), we can select K photos with high conﬁdence scores to construct a robust multiquery set Q that describe a landmark of interest from different aspects. To improve the landmark recognition, faithfully
representative descriptions for categorical landmark photos
are needed. To leverage multiple photos in Q and generate
descriptive representation for a landmark, an effective midlevel pattern mining strategy is proposed in our earlier work
[Wang et al., 2015a] where frequent patches are discovered
by principled minimum description length.
However, this
pattern representation is obtained via an unsupervised fashion, which carries no semantically categorical information in
landmark photos.
To learn high-level discriminative representations for landmark photos, we propose to learn deep features for Q
through the powerful convolutional neural networks (CNNs)
[Krizhevsky et al., 2012] which have shown impressive performance in a variety of recognition tasks. In our case, a trainable deep network can be ﬁne-tuned on the landmark data to
generate semantically high-level features regarding landmark
samples in categories. We describe the design and training
of deep network in Section 3.3. Once multiple deep features
for landmark photos in Q are learned, we aggregate them into
overall feature representation to describe a landmark of interest, and perform similarity search between the query and each
landmark photo in database with their high-level features. In
our paper, we use Euclidean distance to calculate similarity
Remark. One may think only LDA can make the satisﬁed
retrieval results. However 1) the LDA can only detect the
landmarks sharing the similar latent topics above a probability threshold. 2) Even the candidates within the similar topics,
the ﬁnal retrieved landmark candidates still need to be ranked
according to their landmark relevance to achieve a satisﬁed
accuracy based on evaluation metric. To this end, we need to
learn a strong deep feature representations over both multiquery set and landmark photos for the ﬁnal retrieval.
Deep Landmark Feature Learning on
Collaborative Convolutional Neural Networks
The query expansion step produces a set of query photos that
are describing the landmark of interest in different aspects. To
combine these complementary priors, we focus on constructing photo representations, i.e., encoding functions φ mapping
each query photo I to a vector φ(I) ∈Rd, and an effective combination method to integrate multiple vectors into an
overall feature vector. Since these query photos are displaying landmarks with visual variance, we employ the Convolutional Neural Networks (CNN) [Krizhevsky et al., 2012]
with several layers of non-linear feature extractors to generate high-level deep representations.
Deep Representations with Pre-training
Our deep representations are inspired by the success of CNN
in photo classiﬁcation[Krizhevsky et al., 2012]. As shown in
[Donahue et al., 2013; Zeiler and Fergus, 2014], the vector
Given a multi-query set Q in testing, ﬁne-tuned parameter set of CNN-F are applied to feed-forwardly extract
high-level discriminative features for each photo in Q. The resulting multiple feature vectors are encoded using Fisher vector
encoding to generate an overall feature vector which can best describe the landmark of interest in a robust and discriminative
of φ(I) of a deep CNN, learned on large dataset such as photoNet [Deng et al., 2009], can be used as a powerful photo
descriptor applicable to other datasets. Here we adopt a fast
architecture which is similar
to the one used by Krizhevsky et al. [Krizhevsky et al., 2012].
It comprises 8 learnable layers, 5 of which are convolutional,
and the last 3 are fully-connected. The input photo size is
224 × 224. Fast processing is ensured by the 4 pixel stride
in the ﬁrst convolutional layer. The main difference between
CNN-F and that of [Krizhevsky et al., 2012] are the reduced
number of convolutional layers and the dense connectivity between convolutional layers. The structure of CNN-F is shown
in Table 1.
CNN Fine-tuning on the Target Dataset
It was demonstrated [Girshick et al., 2014] that ﬁne-tuning
a pre-trained CNN on the target data can signiﬁcantly improve the performance, and we consider this scenario to obtain photo features which are dataset-speciﬁc to landmark
dataset. In our framework, we ﬁne-tuned CNN-F using the
landmark dataset where ﬁne-tuning was carried out using the
CNN pre-trained parameters on ILSVRC [Russakovsky et al.,
2014]. We employ data augmentation in the form of cropping and ﬂipping. CNN requires photos to be transformed to
a ﬁxed size (224 × 224), and hence the photo is downsized
so that the smallest dimension is equal to 224 pixels. Then
224 × 224 crops are extracted from the four corners and the
centre of the photo. These crops are then ﬂipped about the
y-axis, producing 10 perturbed samples per input photo.
Note that the last fully-connected layer (FC3) has output dimensionality equal to the number of classes, which
differs between datasets. To this end, we cluster the landmark photos within the latent factor with L dimensional space
into C clusters via K-means, which naturally corresponds to
the C pseudo-classes regarding supervision information (see
Fig. 2). Clustering landmark photos in their factorized latent space instead of using their original category priors suggests user related supervision signals. As the latent factors
regarding the landmark photos yielded by matrix factorization follows the principle of collaborative ﬁltering [Shi et al.,
2014] in recommendation system, we name the feature learning procedure as deep landmark feature learning on Collaborative Convolutional Neural Networks (denoted as C-CNNs).
In this way, latent factors characterize rich similarity information among landmark photos, which can facilitate the clustering process to produce accurate clusters as supervision signals. The essence of the proposed C-CNNs is to map latent
factors to the landmark photo pixels, such that the user-photo
correspondence can be encoded. However, latent factors regarding a landmark query could be noisy. To this end, softmax function is adopted [Tang, 2013] on the top layer of the
deep network to classify the membership of input photo probabilistically.
Fisher Vector Encoding on Multi-Query Set
Once we have obtained trainable parameters of C-CNNs,
the multi-query set Q can be transformed through the network to produce multiple high-level feature vectors Q =
{x1, . . . , x|Q|}. To aggregate these vectors into an overall
representation that best describes the landmark of interest,
we employ Fisher Vector to encode them with high-order
statistics [Sanchez et al., 2013] (See Fig. 4). An alternative aggregation strategy is average-pooling, which is formulated as: bx =
i=1 xi. However, average-pooling
is unable to capture the correlation of multiple feature vectors in regards to a particular landmark. In fact, landmarks
within scene photos could exhibit dramatically different appearances, shapes, and aspect ratios.
To distinguish one
landmark category from another, it is much desired to harvest discriminative and representative landmark-speciﬁc object parts, which are collected in the multi-query set Q. To
this end, we use Fisher Vector (FV) [Sanchez et al., 2013] to
aggregates multiple deep feature vectors into a high dimensional non-linear representation that is suitable for classiﬁer.
FV can effectively address geometric variance in scene photos, and can be combined with CNNs [Sydorov et al., 2014;
Perronnin and Larlus, 2015] to improve classiﬁcation performance. We quantitatively evaluate the combination of C-
CNNs with FV or average-pooling, as shown in 4.5.
The Fisher vector encoding Φ of a set of features is based
on ﬁtting a parametric generative model such as the Gaussian Mixture Model (GMM) to the features, and then encoding the derivatives of the log-likelihood of the model with
respect to its parameters [Jaakkola and Haussler, 1998]. It
has been shown to be a state-of-the-art local patch encoding technique [Sanchez et al., 2013; Chatﬁeld et al., 2011].
Our base representation of a query photo is a set of deep
feature vectors corresponding to multi-query set Q. The descriptors are ﬁrst PCA-projected to reduce their dimensionality and decorrelate their coefﬁcients to be amenable to the
FV description based on diagonal-covariance GMM. Given a
GMM with G Gaussians, parameterized by {πg, µg, σg, g =
1 . . . , G}, the Fisher vector encoding leads to the representation which captures the average ﬁrst and second order differences between the features and each of the GMM
centres [Perronnin et al., 2010; Simonyan et al., 2013].
For a descriptor x ∈RD, we deﬁne a vector Φ(x) =
[ϕ1(x), . . . , ϕG(x), ψ1(x), . . . , ψG(x)] ∈R2GD. The subvectors are deﬁned as
where {πg, µg, σg}g are the mixture weights, means, and di-
Table 1: The CNN-F architecture. It contains 5 convolutional layers (conv 1-5) and three fully-connected layers (FC 1-3). The
details of each convolutional layer are given in three sub-rows: the ﬁrst speciﬁes the number of convolution ﬁlters and their
receptive ﬁeld size as “num × size × size”; the second indicates the convolution stride (“st.”) and spatial padding (“pad”); the
third indicates if Local Response Normalisation (LRN) is applied, and the max-pooling downsampling factor.
CNN-F (F-Net)
64 × 11 × 11
st. 4, pad 0
LRN, ×2 pool
256 × 5 × 5
st. 1, pad 2
LRN, ×2 pool
256 × 3 × 3
st. 1, pad 1
256 × 3 × 3
st. 1, pad 1
512 × 3 × 3
st. 1, pad 1
4096 dropout
4096 dropout
C-way soft-max
agonal covariance of the GMM, which are computed on the
training set; γg(x) is the soft assignment weight of the feature x to the g-th Gaussian. In this paper, we use a GMM
with G = 256 Gaussians.
To represent a query set Q, one averages/sum-pool the
vector representations of all descriptors, that is, Φ(Q) =
i=1 Φ(xi). The Fisher vector is further processed by
performing signed square root and ℓ2 normalization on each
dimension d = 1, . . . , 2GD:
¯Φd(Q) = (sign Φd(Q))
||Φ(Q)||ℓ1
For simplicity, we refer to the resulting vectors from Eq.(5)
as Fisher vectors and to their inner product as Fisher kernels.
Experiments
In this section, we present extensive experimental results by
comparison to a variety of baselines and state-of-arts to evaluate the effectiveness of our approach.
Two datasets are constructed by collecting landmark photos
from Flickr and Picasa Web Album. They are suitable for
landmarks retrieval because they contain both user information and corresponding landmark photos.
• Flickr. We use the Flickr API to retrieve landmark photos taken at a city posted by a large number of users.
We sort out 11 cities: London, Paris, Barcelona, Sydney, Singapore, Beijing, Tokyo, Taipei, Cairo, New York
city, and Istanbul. In each city, such as Paris, we obtained photos by querying the associated text tags for famous landmarks such as “Paris Eiffel Tower” or “Paris
Triomphe” 2. Example photos containing a variety of
landmarks from this dataset are shown in Fig. 5.
• Picasa Web Album. Providing rich information about
interesting tourist attractions, this source contains a vast
amount of GPS-tagged photos uploaded by users who
have visited the landmarks, along with their text tags.
We manually download a fraction of photos and their
user information on 6 cities: London, Paris, Beijing,
Sydney, Chicago, and Barcelona.
The statistics for user information and their uploaded photos over the two datasets are summarized in Table 2.
Remark. It is noteworthy to remark the followings
• For our data set, we don’t follow the assumption of
selecting the same landmark photo from the different
users, as also mentioned by our previous conference paper [Wang et al., 2015a], such multi-query expansion
comprising the same redundant landmark photos is not
informative.
Actually, for our practical implementations, we seldom meet such scenario.
2In Paris, 12 queries were used to collect photos from Flickr: La
Defense Paris, Eiffel Tower Paris, Hotel des Invalides Paris, Louvre Paris, Moulin Rouge Paris, Musee d’Orsay Paris, Notre Dame
Paris, Pantheon Paris, Pompidou Paris, Sacre Coeur Paris, Arc de
Triomphe Paris, Paris
Table 2: Statistics of datasets.
Picasa Web Album
# Landmark
# photo per landmark
nearly 1,000
# Total photo
Figure 5: Examples of landmark photos from our collected
Flickr dataset.
• It is more commonly a scenario that the same landmark
with different capturing conditions such as varied capturing angles. Given a possible biased query landmark
photo, we just attempt to choose the other more photos that characterize the same landmark yet with a more
ideal conditions to reﬂect its ground-truth.
• However, we have to admit that each photo set as
we adopt characterizes the same ground-truth landmark
with a relative smaller portions of biased landmark
photo, which ensure to validate the effectiveness of our
multi-query expansion technique.
Training and validation
For all datasets, we split them with the training, validation
and testing 70%, 10% and 20% respectively. The training set
is utilized for C-CNN feature learning and the testing evaluates the learned feature representation. We also leave a small
portion of training set for validation.
As aforementioned,
we perform matrix factorization over the entire training data
by solving Eq. (2) to estimate the parameter β. Note that
we adopt the root-mean-square error [Dror et al., 2011] as
the validation metric to estimate the optimal parameter β for
Eq. (2). The validation process shows that β=0.05 and L=200
can reach satisﬁed performance in terms of root-mean-square
error. Besides, we set the cluster number over latent factors
C=1000 for C-CNN feature learning.
Evaluation Metric
We choose precision-recall as the metrics to evaluate both our model and state-of-the-art methods
over top-100 retrieval ranked list w.r.t each query landmark.
In each landmark, we issue 20 queries and an average precision score is computed for all queries, which are averaged
to obtain a mean Average Precision (mAP) for the each landmark category.
We consider several variants of our model to
understand each component of the proposed C-CNN. Also,
some recent deep scene classiﬁcation methods are considered
as strong baselines:
• CNN-F+Average: The CNN-F model is ﬁne tuned on
original class labels, and then average pooling is used to
generate the overall feature vector.
• CNN-F+FV: The CNN-F model is ﬁne tuned on original
class labels, and then Fisher Vector encoding is used to
generate the overall feature vector.
• C-CNN+Average: The proposed collaborative CNN is
ﬁne tuned on pseudo labels from user supervision, and
then average pooling is used to generate the overall feature vector regarding the multi-query set.
• Ours (C-CNN+FV): The architecture is the same as C-
CNN except that Fisher Vector encoding is employed to
produce the overall feature representation.
• Deep Places Features: This is a strong deep baseline
which uses CNN to learn deep features from the largest
scene-centric database, namely Places Database [Zhou
et al., 2014]. The Places database contains over 7 millions labeled pictures of scenes from which the CNN
features can achieve state-of-the-art results.
• MetaObject-CNN [Wu et al., 2015]: This method is
to learn discriminative features for scene classiﬁcation
by ﬁne-tuning CNN on pre-generated patches containing objects and parts that frequently occur in photos for
scene category.
Competitors
In our experiment, we consider nine competitors listed below. In their implementation of training, SIFT
descriptor [Lowe, 1999] is used as a local descriptor due to
its excellent performance in object recognition [Boureau et
al., 2010]. Speciﬁcally, we adopt a dense sampling strategy
to select the interest regions from which SIFT descriptors are
extracted.
• K-NN [Hays and Efros, 2008]: A feature matching approach to return the K nearest neighbors with respect to
the query landmark photo where a query photo and photos in database are represented by aggregating a set of
low-level features to perform landmark retrieval.
• LF+SVM: Low-level features [Zhu et al., 2008] combined with SVM.
• DRLR [Doersch et al., 2012]: A region based location
recognition method that detects discriminative regions at
the patch-level.
• GIANT [Fang et al., 2013]: A method to discover geoinformative attributes that are discriminative for location
recognition.
• AQE [Chum et al., 2007]: Average Query Expansion
method that proceeds as follows: given a query region,
it ranks a list of photos using tf-idf scores. Bag-of-Word
vectors corresponding to these regions are averaged with
BoW vectors of the query, resulting in an expanded vector used to re-query the database.
• DQE [Arandjelovic and Zisserman, 2012]: Discriminative Query Expansion that enriches a query in the exactly
same way as AQE. It considers photos with lower tf-idf
scores as negative data to train a linear SVM for further
rankings and retrievals.
Figure 6: An example consists of the original test photo (left)
and the corresponding heatmap represented the highest response regions during the prediction.
• PQE [Fernando and Tuytelaars, 2013]: A Pattern based
Query Expansion algorithm that combines top-K retrieved photos with a query to ﬁnd a set of patterns.
• PAMQE [Wang et al., 2015a]:
A query expansion
method by yielding a mid-level pattern representation
over expanded multi-query set via LDA model against
the user-photo matrix.
To ensure its generalization
where test data differs from the dataset used to generate
the quantization, we use a different dataset, the Oxford
dataset3, to construct the vocabulary book from which
local bag-of-words are encoded as representations 4.
• MMHG [Zhu et al., 2015b]: This is an effective modeling scheme to characterize the associations between
landmark photos by using multiple hypergraphs to describe high-order relationship from different aspects.
Tuning Parameters
In experiments, we tune three parameters as follows,
• K: the number of queries after matrix factorization in the
multi-query set.
• λ: the threshold to determine the latent topic set w.r.t the
query landmark.
• L: the reduced dimension or number of latent factor in
matrix factorization.
Following [Wang et al., 2015a], we set K=40, λ=0.4 and
L= 64 for a fair comparison. We set s=20 to select top 20
photos, which characterize the 20 most similar items to the
query landmark described by the C-CNN high-level features,
to construct a compact multi-query set for landmark retrieval.
Comparison with Baselines
This experiment is conducted to evaluate the effectiveness of
our method in capturing the high-level discriminative representations for landmark retrieval by comparison with strong
deep baselines. We use CNN pre-trained on ImageNet with
the hope to reduce the chance of over-ﬁtting to certain scenes.
For the efﬁciency of the feature extraction process, we use
Caffe library [Jia et al., 2014]. For the ﬁne-tuning process,
we take all images in the training set for each category as
the input, and use the CNN to perform a prediction for each
3 
4The Oxford Building dataset contains 5,062 photos, which is a
standard set of particular objects for retrieval. The reason for choosing Oxford landmarks is that the photos exhibit scenes similar to,
rather than identical landmarks, those in the two test databases (e.g.,
buildings have much similarities in their architectural styles).
Table 3: The mAP (%) values of selected landmarks by different approaches against Flickr dataset.
K-NN [Hays and Efros, 2008]
LF+SVM [Zhu et al., 2008]
DRLR [Doersch et al., 2012]
GIANT [Fang et al., 2013]
PAMQE [Wang et al., 2015a]
MMHG [Zhu et al., 2015b]
image. Please note that for the proposed C-CNN, training
images are clustered into pseudo labels. The fully-connected
layer generates a feature vector of 4096-dim which can be
used to train one-vs-all SVMs for each scene category. In
testing, an input image goes through the network model corresponding to each baseline, and its deep features are used
to predict its scene classiﬁcation for each linear SVM model,
then we assign the one with highest conﬁdence score.
In Table 4, we report classiﬁcation accuracies of baselines
on the testing set of Flickr and Picasa datasets.
see that C-CNN model outperforms CNN-F and its variants,
i.e., CNN-F+Average and CNN-F+FV. This veriﬁes that ﬁnetuning CNNs on pseudo labels with user information is helpful in constructing multi-query set from which more discriminative features can be generated. This is mainly because the
latent factors revealed by user-landmark matrix factorization
provide semantics to describe landmark photos from different perspectives. On the other hand, the proposed C-CNN
with Fisher Vector pooling is superior to state-of-the-art deep
baselines, Deep Places Features and MetaObject-CNN. The
main reason is deep places features are trained from a very
large scene-centric dataset which contains photos from search
engines with wide-ranging diversity and density. However,
these trainable parameters cannot be easily applied into social media data without ﬁne-tuning. MetaObject-CNN uses a
region proposal technique to generate a set of patches potentially containing objects, and apply a pre-trained CNN to extract generic deep features from these patches. Consequently,
the MetaObject-CNN is inferior to our model not only because its lack of ﬁne-tuning but also because the region proposal step has no guarantee to generate highly discriminative
patches in describing landmarks. By contrast, the proposed
C-CNN with Fisher Vector with a multi-query set as input can
produce discriminative representations by encoding multiple
deep features in their higher order.
An illustration of feature responses from C-CNN is shown
in Fig. 6. We can see that C-CNN is able to use the most
informative region as the highest response during prediction.
For example, for London clock tower, highest responses come
from tower pin and circular clock plate.
Cross Dataset Generalization
Figure 7: Cross dataset generalization of training and testing
on different datasets. See text for details.
Table 5: mAP of two datasets with respect to modiﬁed architecture of CNN-F feature learning.
Flickr (mAP)
Picasa (mAP)
CNN-F (4096)
CNN-F 
CNN-F (1024)
CNN-F(128)
A well-known problem in deep feature learning for visual recognition is cross dataset generalization. It implies
that training and testing across datasets generally results in
a drop of performance due the dataset bias problem. In this
case, the bias between datasets is due to the data distribution,
density and diversity between the four datasets: ImageNet,
Places dataset, Flickr, and Picasa Web Album. Speciﬁcally,
for training on Flickr and Picasa, we use trainable parameters of CNN-F pre-trained on ImageNet and then ﬁne-tuning
parameters on target dataset. For training on Places dataset,
we directly use the learned parameters since Places dataset
is scene-centric. Fig. 7 shows the classiﬁcation results obtained from training and testing on different permutations on
the four datasets. We can see that features extracted from a
pre-trained ImageNet CNN-F ﬁne-tuned on the training and
testing from the same dataset provides the best performance
for a ﬁxed number of training examples. Although Places
dataset is very large, its performance is inferior to CNN-F
pre-trained on ImageNet with ﬁne-tuning. A possible reason
is features trained from ImageNet are generic and transferable
to a target dataset.
CNN Feature Training
Considering the smaller size of our training dataset when
compared with ILSVRC-2012, we controlled the over-ﬁtting
by using lower initial learning rates for the ﬁne-tuned hidden
layers (FC1 and FC2). The learning rate schedule for the last
layer and hidden layers was: (10−1, 10−4) →(10−3, 10−4)
→(10−4, 10−4) →(10−5, 10−5). Our network has the same
dimensionality of the last hidden layer (FC2): 4096. This
design choice is in accordance with state-of-the-art architecture [Krizhevsky et al., 2012; Chatﬁeld et al., 2014]. We further train three modiﬁcations of the CNN-F network, with
lower dimensional FC2 layers of 2048, 1024, and 128 dimensions, respectively. To speed up training, all layers aside from
FC2/FC3 were set to the those of the CNN-F net and a lower
initial learning rate of 10−3 was used. The initial learning rate
of FC2/FC3 was set to 10−2. Experimental results are given
in Table 5. It can be seen that mAP values of two datasets decrease as the dimensionality of the last hidden layer becomes
lower. One possible reason is 4096 is already rather compact,
and further reduction on dimensionality would lead to underperformed results.
Comparison with State-of-the-art Approaches
We evaluate mAP for our approach and competitors.
each landmark in Flickr and Picasa Web Album, we randomly sample 20 query photos for each landmark and per-
Table 4: The classiﬁcation accuracies/precision by different baselines against Flickr and Picasa Web Album datasets.
CNN-F+Average
C-CNN+Average
Deep Places Features [Zhou et al., 2014]
MetaObject-CNN [Wu et al., 2015]
54.32±0.14
58.42±0.76
58.61±0.78
60.68±0.92
59.29±0.33
64.18±0.88
56.79±0.37
57.22±0.92
56.59±0.85
57.79±0.99
57.18±0.31
61.23±0.76
Figure 8: Precision-recall results over Flickr and Picasa.
form landmark retrieval to return the ranking list, where
we obtain the precision-recall value and plot a precisionrecall curve, plotting precision p(r) versus the recall r in
8, where our method outperforms others especially
over our recent PAMQE [Wang et al., 2015a] to demonstrate the strength of high-level deep features learned over
user-landmark latent subspace.
For each dataset, we also
use mAP as the evaluation metric to examine the performance of each approach.
In the case of duplicate landmark photos, the evaluation protocol of mean average precision (mAP) considers that a duplicate photo to the query
is viewed as ‘’junk” [Philbin et al., 2007]. This protocol is
a common setting in object retrieval [Philbin et al., 2007;
Zheng et al., 2015], and won’t affect the retrieval accuracy
For a query q, the average precision (AP) is deﬁned as
r=1 Pq(r)θq(r), where Lq is the ground-truth
neighbors of query q in database, n is the number of photos
in ranked list, we set n = 100, Pq(r) denotes the precision
of the top r retrieved photos, and θq(r) = 1 if the r-th retrieved photo is a ground-truth within this landmark category
and θq(r) = 0, otherwise. In our case, given 20 query photos
for each landmark, the mAP is deﬁned over all 20 queries for
each landmark as: mAP =
i=1 AP(qi). In the step of
multi-query expansions, by default, the multi-query set Q are
composed of 40 recommended photos.
The compared landmark retrieval results with mAP values
are shown in Table 3 and Table 6. We observe that: (1) Our
method and PAMQE outperform all competitors, due to the
effectiveness of exploiting the complementary information of
multiple queries, while our method is better than PAMQE
due to the superiority of high-level features over mid-level
pattern representation; (2) The large intra-class variance limits the performance of LF+SVM and K-NN, especially for the
Flickr dataset; (3) DRLR detects discriminative regions from
a single query photo, which degrades its performance when a
query photo was shot from a bad viewpoint; and (4) MMHG
works by developing multiple hypergraphs to identify the associations between landmark photos. However, they are still
using low-level features such as color moments and local binary patterns, making them underperformed. Although GI-
ANT also performs better, it only utilizes user-generated content to obtain visual attributes. This also demonstrates the
need of exploiting user information to assist query understanding.
Comparison with Query Expansion
Approaches
Unlike AQE and DQE where plausible queries are selected
via a low-level feature matching procedure, the proposed
multi-query selection can complement a q-user by exploiting latent topics and information from users. While PQE
uses similar scheme to expand a single query into a query
set, its multi-query set is determined by manual selection.
To demonstrate the superiority of our method over existing
multiple query methods that can be adopted for landmark retrieval, we perform comparison against several query expansion approaches: AQE, DQE, PQE and PAMQE. Results
are shown in Fig.9, where we conclude that PAMQE outperforms AQE, DQE, and PQE by a large margin in terms of
mAP values in two databases. However, it performs inferior
to the proposed C-CNN with Fisher vector encoding, which
can produce highly discriminative features for landmark retrieval.
Comparison of query expansion methods over
Conclusions
In this paper, we propose a novel collaborative deep networks
for robust landmark retrieval, which works over landmark latent factors to further generate the high-level semantic feature
for both multi-query set and other landmark photos. Compared with both low-level feature and mid-level pattern representation based methods, our proposed method achieved
state-of-the-art performance, validated by experimental results on real-world social landmark photo datasets associated
with the user information.
Table 6: The mAP values (%) of selected landmarks by different approaches against Picasa Web Album dataset.
K-NN [Hays and Efros, 2008]
LF+SVM [Zhu et al., 2008]
DRLR [Doersch et al., 2012]
GIANT [Fang et al., 2013]
PAMQE [Wang et al., 2015a]
London clock
Eiffel tower
Forbidden city
Opera house
Catalunya plaza
Chicago plaza
Average mAP